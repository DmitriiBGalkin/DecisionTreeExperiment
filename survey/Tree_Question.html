{{ block style }}
    <link rel="stylesheet" type="text/css" href="{{ static 'survey/global_style.css' }}">
 <style>
     .otree-form-errors{
     display: none;
     }
 .slider-wrapper {
    position: relative; /* Important: make slider-wrapper the positioning parent */
}
.error-message {
    margin-top: 8px; /* space from the slider */
    background: #ffffff;
    color: #d9534f; /* red color for errors */
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1.1em;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    white-space: normal;
    text-align: center;
    display: block;
}

.error-message:empty {
    display: none;
}



</style>
{{ endblock }}

{{ block scripts }}
<script>
window.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ JS loaded for Tree_Question with Bootstrap alert handling');

    const dummySlider   = document.getElementById('dummy_slider');
    const realSlider    = document.getElementById('confidence_slider');
    const sliderValue   = document.getElementById('sliderValue');
    const sliderWrapper = document.querySelector('.slider-wrapper');
    const errorMessage  = document.getElementById('confidence-error');

    const submitButton     = document.querySelector('button.otree-btn-next');
    const interactionInput = document.getElementById('interaction_times');
    const perPageInput     = document.getElementById('per_page_time');
    const form             = document.querySelector('form'); // oTree page form

    if (!dummySlider || !realSlider || !sliderWrapper) {
        console.error('‚ùå Missing one of: dummy_slider, confidence_slider, slider-wrapper');
    }
    if (!submitButton)     console.warn('‚ö†Ô∏è Submit button not found');
    if (!interactionInput) console.warn('‚ö†Ô∏è Hidden input #interaction_times not found');
    if (!perPageInput)     console.warn('‚ö†Ô∏è Hidden input #per_page_time not found');
    if (!form)             console.warn('‚ö†Ô∏è Form element not found');

    let isDragging = false;
    let hasInteracted = false;
    const t0 = performance.now();

    let firstSliderTime = null;
    let lastSliderTime  = null;
    const radioChanges  = [];

    // initial UI state
    if (dummySlider) {
        dummySlider.style.visibility = 'hidden';
        // mark as pristine so (optional) CSS can hide the thumb until first interaction
        dummySlider.classList.add('pristine');
    }
    if (sliderValue) {
        sliderValue.innerText = '';
        sliderValue.style.visibility = 'hidden';
    }

    // hide empty server-side error
    if (errorMessage && !errorMessage.textContent.trim()) {
        errorMessage.classList.add('d-none');
        console.log('‚ÑπÔ∏è No server-side error: alert hidden');
    }

    function hideError() {
        if (errorMessage && !errorMessage.classList.contains('d-none')) {
            errorMessage.classList.add('d-none');
            console.log('üßπ Error alert hidden after interaction');
        }
    }

    function revealSliderUI() {
        if (dummySlider) {
            dummySlider.style.visibility = 'visible';
            dummySlider.classList.remove('pristine'); // show thumb after first real interaction
        }
        if (sliderValue) {
            sliderValue.style.visibility = 'visible';
        }
        hasInteracted = true;
        console.log('üü¢ First time slider shown / interacted');
    }

    function updateSliderFromEvent(e) {
        const rect = sliderWrapper.getBoundingClientRect();
        const clickPos = (e.clientX - rect.left) / rect.width * 100;
        const clampedPos = Math.max(0, Math.min(100, clickPos));
        const value = Math.round(clampedPos);

        dummySlider.value = value;
        realSlider.value = value;
        sliderValue.innerText = value;

        if (!hasInteracted) revealSliderUI();

        hideError();
        clearSliderValidity();

        const now = Math.round(performance.now() - t0);
        if (firstSliderTime === null) {
            firstSliderTime = now;
            console.log(`üü¢ First slider interaction at: ${firstSliderTime} ms (value=${value})`);
        }
        lastSliderTime = now;
        console.log(`‚ÜîÔ∏è Slider moved at: ${lastSliderTime} ms (value=${value})`);
    }

    // --- Native-like validation for the slider (key change) ---
    function clearSliderValidity() {
        if (dummySlider) dummySlider.setCustomValidity('');
    }

    function blockIfSliderMissing(e) {
        const notChosenYet = !realSlider || realSlider.value === '' || isNaN(Number(realSlider.value));
        if (notChosenYet) {
            e.preventDefault();
            e.stopPropagation();
            // Localized message (server-templated)
            dummySlider.setCustomValidity(
                "{{ if en }}Please choose a confidence value.{{ else }}Bitte w√§hlen Sie einen Sicherheitswert.{{ endif }}"
            );
            // ‚ùå Do NOT reveal slider UI on failed submit (prevents the dot from appearing)
            // revealSliderUI();

            // Trigger the native popup exactly like radios do
            dummySlider.reportValidity();

            console.log('‚õî Submission blocked: slider value missing');
            return true;
        }
        return false;
    }
    // ----------------------------------------------------------

    // Pointer interactions on the custom slider area
    if (sliderWrapper) {
        sliderWrapper.addEventListener('mousedown', function(e) {
            isDragging = true;
            updateSliderFromEvent(e);
        });

        window.addEventListener('mousemove', function(e) {
            if (isDragging) updateSliderFromEvent(e);
        });

        window.addEventListener('mouseup', function() {
            if (isDragging && lastSliderTime !== null) {
                console.log(`üî¥ Drag end at: ${lastSliderTime} ms (value=${dummySlider.value})`);
            }
            isDragging = false;
        });
    }

    // Dummy slider input (keyboard or pointer)
    if (dummySlider) {
        dummySlider.addEventListener('input', function() {
            realSlider.value = this.value;
            sliderValue.innerText = this.value;

            if (!hasInteracted) revealSliderUI();

            hideError();
            clearSliderValidity();

            const now = Math.round(performance.now() - t0);
            if (firstSliderTime === null) {
                firstSliderTime = now;
                console.log(`üü¢ First slider interaction at: ${firstSliderTime} ms`);
            }
            lastSliderTime = now;
            console.log(`‚ÜîÔ∏è Slider input at: ${lastSliderTime} ms (value=${this.value})`);
        });

        // Clear any custom validity on pointer down / change as well
        dummySlider.addEventListener('mousedown', clearSliderValidity);
        dummySlider.addEventListener('change', clearSliderValidity);
    }

    // radios
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const time = Math.round(performance.now() - t0);
            const value = radio.value;
            radioChanges.push({ value, time });
            console.log(`üéØ Radio changed to "${value}" at: ${time} ms`);
        });
    });

    // Submit (use the form submit event so it also catches Enter key, etc.)
    if (form) {
        form.addEventListener('submit', (e) => {
            // Block submission if slider not chosen (native-style popup)
            if (blockIfSliderMissing(e)) return;

            // persist the interaction log + page time
            const now = Math.round(performance.now() - t0);
            const log = {
                slider_first: firstSliderTime,
                slider_last: lastSliderTime,
                radio_changes: radioChanges,
                next_click: now
            };
            if (interactionInput) interactionInput.value = JSON.stringify(log);
            if (perPageInput)     perPageInput.value     = Math.round(now / 1000);

            console.log('‚úÖ Form interaction log:', log);
            console.log('‚è±Ô∏è Page time (s):', perPageInput ? perPageInput.value : '(missing #per_page_time)');
        }, { capture: true }); // run before default validation bubbles up
    }

    // Optional: keep the button handler only for safety; it will early-return if blocked
    if (submitButton) {
        submitButton.addEventListener('click', (e) => {
            if (blockIfSliderMissing(e)) return;
            // No extra work; the form 'submit' handler does the logging
        }, { capture: true });
    }
});
</script>

{{ endblock }}



{% block form_errors %}
<!-- Override the default error block: don't show global errors -->
{% endblock %}


{{ block content }}
<input type="hidden" name="interaction_times" id="interaction_times">
<input type="hidden" name="per_page_time" id="per_page_time">

<div class="box">
    <h4>{{ if en }}Decision Tree Task{{ else }}Entscheidungsbaum-Aufgabe{{ endif }} ({{ player.round_number }}/{{ number_of_rounds }}).</h4>
    <b>{{ if en }}Instructions:{{ else }}Anweisungen:{{ endif }}</b>
    <p>
        {{ if en }}
            Please review the <b>decision tree</b> and your <b>profile information</b>.
            Decide whether the loan application would be <b>approved or denied</b> based on the information, and indicate how confident you are in your answer.
        {{ else }}
            Bitte betrachten Sie den <b>Entscheidungsbaum</b> und  <b>Ihre pers√∂nlichen Daten</b> aufmerksam.
            Entscheiden Sie, ob Ihr Antrag f√ºr einen Kredit aufgrund dieser Informationen durch eine Bank <b>genehmigt oder abgelehnt </b>  werden wird.
            Geben Sie anschlie√üend an, <b> wie sicher Sie sich bei Ihrer Entscheidung </b>  sind.
        {{ endif }}
    </p>
</div>

<!-- Two-column layout -->
<div class="container-flex">
    <!-- Left Side (Decision Tree) -->
    <div class="left-container">
            {{ include svg_template }}
    </div>

    <!-- Right Side (Loan Applicant Info) -->
    <div class="right-container">
    {{ include 'survey/Table_Profile_Information.html'}}
    </div>
</div>

<!-- Questions Section -->
<div class="form-container">
        {{ formfield 'question_loan' }}
</div>

<div class="form-container">
    {{ Lexicon.confidence_level_label }}
  <div class="slider-container">
      <div class="slider-ticks-top">
    <span class="tick-label left">0</span>
    <span class="tick-label right">100</span>
  </div>
    <div class="slider-wrapper">
      <!-- Background track -->
      <div class="slider-track"></div>

      <!-- Dummy input for user interaction -->
      <input
        type="range"
        id="dummy_slider"
        min="0"
        max="100"
        step="1"
        value="" required>  <!-- or blank if you prefer -->


      <!-- Real hidden input for oTree submission -->
      <input
        type="hidden"
        id="confidence_slider"
        name="confidence_level"
      >
    </div>
    <div class="value-display">
      {{ Lexicon.value_label_prefix }} <span id="sliderValue"></span> {{ Lexicon.value_label_suffix }}
        <div id="confidence-error" class="alert alert-warning" role="alert">
  {{ formfield_errors 'confidence_level' }}
</div>
    </div>

  </div>
</div>

  <div class="btn-container">
    {{ next_button }}
  </div>

{{ endblock }}

